#!/bin/bash
#
# Creates defaults directories setup in directories.env; copies or links
# configuration files into place as appropriate.
#
# This needs to be run once.
#

CURRENT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

function _powerline_install() {
    if [ ! -f ~/.local/bin/powerline ]; then
        pip install --user git+git://github.com/powerline/powerline
    fi
}

function _go_config() {
    if [ -n "$GOPATH" ]; then
	go get -u github.com/nsf/gocode
	"$GOPATH/src/github.com/nsf/gocode/nvim/symlink.sh" > /dev/null 2>&1
    fi
}

function _fetch_apps() {
    if [ ! -d ~/repos/gruf ]; then
        git clone https://github.com/svrana/gruf.git ~/repos/gruf
        estatus "Cloned gruf"
    fi

    if [ ! -d ~/repos/solarize ]; then
        git clone https://github.com/gmodarelli/solarize.git ~/repos/solarize
        ~/repos/solarize/solarize.sh dark
        estatus "Cloned solarize repo"
    fi

    if [ ! -d ~/.vim/bundle/Vundle.vim ]; then
        git clone https://github.com/VundleVim/Vundle.vim.git ~/.vim/bundle/Vundle.vim
        estatus "Cloned Vundle"
    fi

    if [ ! -f ~/.config/nvim/init.vim ]; then
        mkdir ~/.config/nvim
        ln -sf "${RC_DIR}/vimrc" ~/.config/nvim/init.vim
        sudo update-alternatives --install /usr/bin/vi vi /usr/bin/nvim 60
        sudo update-alternatives --install /usr/bin/vim vim /usr/bin/nvim 60
        sudo update-alternatives --install /usr/bin/editor editor /usr/bin/nvim 60
    fi

    if [ ! -d ~/repos/fzf ]; then
        git clone --depth 1 https://github.com/junegunn/fzf.git ~/repos/fzf
	GOBIN="" ~/repos/fzf/install --bin
        ln -sf ~/repos/fzf/bin/fzf "${BIN_DIR}/fzf"
        ln -sf ~/repos/fzf/bin/fzf-tmux "${BIN_DIR}/fzf-tmux"
        mkdir -p ~/.config/fzf
        ln -sf "${RC_DIR}/fzf.bash" ~/.config/fzf/fzf.bash
    fi

    if [ ! -d ~/repos/fonts ]; then
        git clone https://github.com/powerline/fonts.git ~/repos/fonts
        ~/repos/fonts/install.sh
    fi

    nvim +PluginInstall +qall +GoInstallBinaries

    _powerline_install
    _go_config
}

function _make_dirs() {
    mkdir -p "$BIN_DIR"
    mkdir -p "$DOWNLOADS"
    mkdir -p ~/apps
    mkdir -p ~/repos
    mkdir -p ~/.config/nvim/bak
    mkdir -p ~/.config/nvim/after/ftplugin
    mkdir -p ~/.config/fontconfig/conf.d
    mkdir -p ~/.fonts
    mkdir -p ~/.vim/swp
    mkdir -p ~/.vim/bundle
    mkdir -p ~/.vim/autoload
    mkdir -p ~/.kitchen
    mkdir -p ~/.config/alacritty
    mkdir -p ~/.config/powerline
    mkdir -p ~/.local/share/applications
    mkdir -p ~/.tmux/plugins
    mkdir -p ~/.ipython/profile_default

    egood "Created default directories as specified in $CURRENT_DIR/directories.env"
}

function _link_dirs() {
    ln -Tsf "$DROPBOX_ROOT/Documents" "$DOCUMENTS"
    ln -Tsf "$DROPBOX_ROOT/Music" "$MUSIC"
    ln -Tsf "$DROPBOX_ROOT/Pictures" "$PHOTOS"
}

function _link_ftplugins() {
    for i in $(dolisting ftplugin/*)
    do
	i=$(basename "$i")
	ln -sf "$CURRENT_DIR/ftplugin/$i" ~/.config/nvim/after/ftplugin/"$i"
    done
}

function _link_configs() {
    ln -sf "${RC_DIR}/bash_profile" ~/.bash_profile
    ln -sf "${RC_DIR}/bashrc" ~/.bashrc
    ln -sf "${RC_DIR}/zshrc" ~/.zshrc
    ln -sf "${RC_DIR}/vimrc" ~/.vimrc
    ln -sf "${RC_DIR}/tmux.conf" ~/.tmux.conf
    ln -sf "${RC_DIR}/gitconfig" ~/.gitconfig
    ln -sf "${RC_DIR}/rvmrc" ~/.rvmrc
    ln -sf "${RC_DIR}/ackrc" ~/.ackrc
    ln -sf "${RC_DIR}/psqlrc" ~/.psqlrc
    ln -sf "${RC_DIR}/kitchen-config.yml" ~/.kitchen/config.yml
    ln -sf "${RC_DIR}/ctags" ~/.ctags
    ln -sf "${RC_DIR}/alacritty.yml" ~/.config/alacritty/alacritty.yml
    ln -sf "${RC_DIR}/powerline-shell.json" ~/.config/powerline/config.json
    ln -sf "${RC_DIR}/ipython_config.py" ~/.ipython/profile_default/ipython_config.py

    ln -sf "${CONFIG_DIR}/misc/alacritty.desktop" ~/.local/share/applications
    ln -sf "${CONFIG_DIR}/misc/dircolors.ansi-dark" ~/.dircolors
    ln -sf "${CONFIG_DIR}/misc/PowerlineSymbols.otf" ~/.fonts/PowerlineSymbols.otf
    ln -sf "${CONFIG_DIR}/misc/50-enable-terminess-powerline.conf" ~/.config/fontconfig/conf.d/

    egood "Created home directory file links"

    _link_ftplugins
}

function _prep_scripts() {
    for i in $(dolisting "$SCRIPT_DIR"/*)
    do
	chmod +x "$i"
    done
    egood "Added execute permission to scripts in $SCRIPT_DIR"

    for i in $(dolisting "$SCRIPT_DIR/*")
    do
	i=$(basename "$i")
	ln -sf "${SCRIPT_DIR}/$i" "${BIN_DIR}/$i"
    done
    egood "Created links in ${BIN_DIR} to scripts in $SCRIPT_DIR"
}

function _prep_fonts() {
    fc-cache -vf ~/.fonts > /dev/null 2>&1
    estatus "Built font cache for powerline"
}

function _chef_bootstrap() {
    force=${1:-"false"}

    first_run=$(which chef-solo)
    if [ -z "$first_run" ]; then
	curl -L https://omnitruck.chef.io/install.sh -o "$TMP/install.sh"
	sudo bash /tmp/install.sh -P chefdk
	estatus "Installed chefdk"
	rm /tmp/install.sh > /dev/null 2>&1
    fi

    if [[ -z "$first_run" || "$force" = "true" ]]; then
	"$CURRENT_DIR/scripts/chef-up"
	estatus "Ran chef-solo"
    else
	egood "Skipped chef-solo run"
    fi
}

# Setup defaults required by these dotfiles
. "${CURRENT_DIR}/config.env"


force_chef_run="false"
while getopts f opt
do
  case "$opt" in
    f)  force_chef_run="true";;
    \?)   # unknown flag
      echo >&2 \
      "usage: $0 [-f force chef-solo run ]"
      exit 1;;
  esac
done
shift "$((OPTIND-1))"

_chef_bootstrap "$force_chef_run"
_make_dirs
_link_dirs
_link_configs
_prep_scripts
_prep_fonts
_fetch_apps
