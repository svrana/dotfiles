#!/bin/bash
#
# Creates defaults directories setup in directories.env; copies or links
# configuration files into place as appropriate.
#
# This needs to be run once.
#

fetch_repos() {
    if [ ! -e /usr/local/bin/pip ]; then
        sudo apt-get install curl python-pip python-dev build-essential
        sudo pip install --upgrade pip
        sudo pip install --upgrade virtualenv
        sudo pip install --upgrade virtualenvwrapper
    fi

    if [ ! -d ~/repos/pidcat ]; then
        git clone https://github.com/JakeWharton/pidcat.git ~/repos/pidcat
        estatus "Cloned pidcat"
    fi

    if [ ! -d ~/repos/gruf ]; then
        git clone https://github.com/svrana/gruf.git ~/repos/gruf
        estatus "Cloned gruf"
    fi

    if [ ! -d ~/repos/solarize ]; then
        git clone https://github.com/gmodarelli/solarize.git ~/repos/solarize
        ~/repos/solarize/solarize.sh dark
        estatus "Cloned solarize repo"
    fi

    if [ ! -d ~/.vim/bundle/command-t ]; then
        git clone https://github.com/wincent/Command-T.git ~/.vim/bundle/command-t
        estatus "Cloned Command-t repo"
        pushd ~/.vim/bundle/command-t/ruby/command-t/
        ruby extconf.rb
        make > /dev/null 2>&1
        popd
    fi

    if [ ! -d ~/.vim/bundle/vim-colors-solarized ]; then
        git clone git://github.com/altercation/vim-colors-solarized.git ~/.vim/bundle/vim-colors-solarized
        estatus "Cloned vim-colors-solarized repo"
    fi

    if [ ! -d ~/.vim/bundle/vim-javascript-syntax ]; then
        git clone https://github.com/jelera/vim-javascript-syntax.git ~/.vim/bundle/vim-javascript-syntax
        estatus "Cloned vim-javascript-syntax repo"
    fi

    if [ ! -d ~/.vim/bundle/vim-javascript ]; then
        git clone https://github.com/pangloss/vim-javascript.git ~/.vim/bundle/vim-javascript
        estatus "Cloned vim-javascript repo"
    fi

    if [ ! -d ~/.vim/bundle/vim-fugitive ]; then
        curl -LSso ~/.vim/autoload/pathogen.vim https://tpo.pe/pathogen.vim
        estatus "Cloned vim-fugitive repo"
    fi

    if [ ! -f ~/.vim/autoload/pathogen.vim ]; then
        curl -LSso ~/.vim/autoload/pathogen.vim https://tpo.pe/pathogen.vim
        estatus "Installed pathogen"
    fi

    if [ ! -d ~/.vim/bundle/DeleteTrailingWhitespace ]; then
        git clone https://github.com/vim-scripts/DeleteTrailingWhitespace.git ~/.vim/bundle/DeleteTrailingWhitespace
        estatus "Cloned DeleteTrailingWhitespace"
    fi

    if [ ! -d ~/.vim/bundle/matchit ]; then
        git clone https://github.com/vim-scripts/matchit.zip.git ~/.vim/bundle/matchit
        estatus "Cloned matchit"
    fi

    if [ ! -d ~/.vim/bundle/supertab ]; then
        git clone https://github.com/ervandew/supertab.git ~/.vim/bundle/supertab
        estatus "Cloned supertab"
    fi

    if [ ! -d ~/.vim/bundle/vim-go ]; then
        git clone https://github.com/fatih/vim-go ~/.vim/bundle/vim-go
        estatus "Cloned vim-go"
    fi

    if [ ! -d ~/.vim/bundle/html5.vim ]; then
        git clone https://github.com/othree/html5.vim.git ~/.vim/bundle/html5.vim
        estatus "Cloned html5.vim"
    fi

    if [ ! -d ~/.vim/bundle/pyflakes-pathogen ]; then
        git clone https://github.com/mitechie/pyflakes-pathogen.git ~/.vim/bundle/pyflakes-pathogen
        estatus "Cloned pyflakes"
    fi

    if [ ! -d ~/.vim/bundle/pydoc.vim ]; then
        git clone https://github.com/fs111/pydoc.vim.git ~/.vim/bundle/pydoc.vim
	estatus "Cloned pydoc"
    fi

    if [ ! -d ~/.vim/bundle/jedi-vim ]; then
        git clone --recursive https://github.com/davidhalter/jedi-vim.git ~/.vim/bundle/jedi-vim
        estatus "Cloned jedi-vim"
    fi

    if [ ! -d ~/.vim/bundle/vim-python-pep8-indent ]; then
        git clone https://github.com/hynek/vim-python-pep8-indent.git ~/.vim/bundle/vim-python-pep8-indent
        estatus "Cloned vim-python-pep8-indent"
    fi

    if [ ! -d ~/.vim/bundle/yaml-vim ]; then
        git clone https://github.com/ingydotnet/yaml-vim ~/.vim/bundle/yaml-vim
        estatus "Clonsed yaml-vim"
    fi

    if [ ! -d ~/.tmux/plugins/tpm ]; then
        mkdir -p ~/.tmux/plugins
        git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
        estatus "Cloned Tmux Plugin Manger"
    fi
}

powerline_install() {
    if [ ! -f ~/.local/bin/powerline ]; then
        pip install --user git+git://github.com/Lokaltog/powerline
    fi
}

current_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
# Setup defaults required by these dotfiles
. ${current_dir}/config.env

mkdir -p $BIN_DIR
mkdir -p $MY_TMP
mkdir -p ~/.bak
mkdir -p ~/.config/fontconfig/conf.d
mkdir -p ~/.fonts
mkdir -p ~/.vim/swp
mkdir -p ~/.vim/bundle
mkdir -p ~/.vim/autoload

if [ "${HOME}" != "/root" ]; then
    mkdir -p ~/apps
    mkdir -p ~/repos

    mkdir -p $DOWNLOADS

    ln -Tsf $DROPBOX_ROOT/Documents $DOCUMENTS
    ln -Tsf $DROPBOX_ROOT/Music $MUSIC
    ln -Tsf $DROPBOX_ROOT/Pictures $PHOTOS
fi

egood "Created default directories as specified in $current_dir/directories.env"

ln -sf ${RC_DIR}/bash_profile 	    ~/.bash_profile
ln -sf ${RC_DIR}/bashrc             ~/.bashrc
ln -sf ${RC_DIR}/vimrc              ~/.vimrc
ln -sf ${RC_DIR}/tmux.conf 	    ~/.tmux.conf
ln -sf ${RC_DIR}/gitconfig          ~/.gitconfig
ln -sf ${RC_DIR}/rvmrc              ~/.rvmrc
ln -sf ${RC_DIR}/ackrc              ~/.ackrc
ln -sf ${RC_DIR}/psqlrc             ~/.psqlrc
ln -sf ${RC_DIR}/10-powerline-symbols.conf      ~/.config/fontconfig/conf.d/10-powerline-symbols.conf
ln -sf ${CONFIG_DIR}/misc/dircolors.ansi-dark   ~/.dircolors
ln -sf ${CONFIG_DIR}/misc/PowerlineSymbols.otf  ~/.fonts/PowerlineSymbols.otf
ln -sf ~/repos/pidcat/pidcat.py ${BIN_DIR}/pidcat

egood "Created home directory file links"

fc-cache -vf ~/.fonts > /dev/null 2>&1
estatus "Built font cache for powerline"

for i in $(ls -1 $SCRIPT_DIR)
do
    chmod +x ${SCRIPT_DIR}/$i
done
egood "Added execute permission to scripts in $SCRIPT_DIR"

for i in $(ls -1 $SCRIPT_DIR)
do
    ln -sf ${SCRIPT_DIR}/$i ${BIN_DIR}/$i
done
egood "Created links in ${BIN_DIR} to scripts in $SCRIPT_DIR"

if [ "${HOME}" != "/root" ]; then
    fetch_repos
    powerline_install
fi

source ~/.bashrc
